<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Tauri Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f3f4f6; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
    </style>

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js');
        }
    </script>
</head>
<body class="p-6">

    <div class="max-w-3xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">GitHub Tauri Builder</h1>

        <!-- Step 1: Configuration -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">1. 設定 (GitHub Token)</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    GitHub Personal Access Token (Repo & Workflow scope)
                    <a href="https://github.com/settings/tokens/new?scopes=repo,workflow&description=TauriBuilderApp" target="_blank" class="text-blue-600 hover:text-blue-800 text-xs ml-2 underline">
                        (トークンを作成する)
                    </a>
                </label>
                <input type="password" id="github-token" class="w-full p-2 border rounded" placeholder="ghp_xxxxxxxxxxxx">
                <p class="text-xs text-gray-500 mt-1">※ブラウザのローカルストレージにのみ保存されます。</p>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">GitHub Username</label>
                <input type="text" id="github-user" class="w-full p-2 border rounded" placeholder="username">
            </div>
            <div class="flex gap-2">
                <button id="btn-save-config" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">設定を保存</button>
                <button id="btn-fetch-repos" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">リポジトリ一覧を取得</button>
            </div>
        </div>

        <!-- Step 2: Select Repository -->
        <div class="card opacity-50 pointer-events-none" id="step-2-card">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">2. リポジトリ選択 (GitHub Pages Active)</h2>
            <p class="text-sm text-gray-600 mb-2">GitHub Pagesが有効になっているリポジトリのみ表示しています。</p>
            <select id="repo-select" class="w-full p-2 border rounded mb-4">
                <option value="">リポジトリを選択してください...</option>
            </select>
            
            <div id="workflow-status-area" class="mb-4 p-3 bg-gray-100 rounded hidden">
                <p id="workflow-status-msg" class="text-sm font-bold mb-2"></p>
                <button id="btn-upload-workflow" class="bg-purple-600 text-white px-3 py-1 rounded text-sm hover:bg-purple-700 hidden">
                    tauri.yml を作成・アップロード
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Workflow Filename</label>
                    <input type="text" id="workflow-file" class="w-full p-2 border rounded" value="tauri.yml">
                    <p class="text-xs text-gray-500">例: .github/workflows/<b>tauri.yml</b></p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Branch</label>
                    <input type="text" id="target-branch" class="w-full p-2 border rounded" value="main">
                </div>
            </div>

            <button id="btn-trigger-build" class="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 w-full font-bold">
                Tauriビルド (exe) を開始
            </button>
        </div>

        <!-- Logs -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-2">ログ / ステータス</h2>
            <pre id="log-output" class="bg-gray-900 text-green-400 p-4 rounded h-48 overflow-y-auto text-sm"></pre>
        </div>
    </div>

<script>
    const tokenInput = document.getElementById('github-token');
    const userInput = document.getElementById('github-user');
    const repoSelect = document.getElementById('repo-select');
    const step2Card = document.getElementById('step-2-card');
    const logOutput = document.getElementById('log-output');
    const workflowStatusArea = document.getElementById('workflow-status-area');
    const workflowStatusMsg = document.getElementById('workflow-status-msg');
    const btnUploadWorkflow = document.getElementById('btn-upload-workflow');
    const workflowFileInput = document.getElementById('workflow-file');

    // Default Workflow Content
    const DEFAULT_WORKFLOW_CONTENT = `name: Build Tauri App

on:
  workflow_dispatch: # これにより、GUIアプリやGitHub上から手動実行が可能になります

jobs:
  build-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            args: ''

    runs-on: \${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          # Those targets are only used on macos runners so it's in an \`if\` to slightly speed up windows and linux builds.
          targets: \${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf

      - name: install frontend dependencies
        run: npm install # or pnpm install / yarn install

      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: \${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: app-v__VERSION__ # the action automatically replaces \`__VERSION__\` with the app version
          releaseName: 'App v__VERSION__'
          releaseBody: 'See the assets to download this version and install.'
          releaseDraft: true
          prerelease: false
          args: \${{ matrix.args }}
`;

    // Default Workflow Content
    const DEFAULT_WORKFLOW_CONTENT = `name: Build Tauri App

on:
  workflow_dispatch:

jobs:
  build-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'windows-latest'
            args: ''

    runs-on: \${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: \${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf

      - name: install frontend dependencies
        run: npm install

      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: \${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: app-v__VERSION__
          releaseName: 'App v__VERSION__'
          releaseBody: 'See the assets to download this version and install.'
          releaseDraft: true
          prerelease: false
          args: \${{ matrix.args }}
`;

    // Logger
    function log(msg, type='info') {
        const time = new Date().toLocaleTimeString();
        const color = type === 'error' ? 'red' : (type === 'success' ? '#4ade80' : 'inherit');
        logOutput.innerHTML += `<div style="color:\${color}">[\${time}] \${msg}</div>`;
        logOutput.scrollTop = logOutput.scrollHeight;
    }

    // Save/Load Config
    document.getElementById('btn-save-config').addEventListener('click', () => {
        localStorage.setItem('gh_tauri_token', tokenInput.value);
        localStorage.setItem('gh_tauri_user', userInput.value);
        log('設定を保存しました。', 'success');
    });

    window.addEventListener('load', () => {
        tokenInput.value = localStorage.getItem('gh_tauri_token') || '';
        userInput.value = localStorage.getItem('gh_tauri_user') || '';
    });

    // Check Workflow File Existence
    async function checkWorkflowExistence(repoName) {
        const token = tokenInput.value;
        const user = userInput.value;
        const filename = workflowFileInput.value;
        const path = `.github/workflows/\${filename}`;

        workflowStatusArea.classList.remove('hidden');
        workflowStatusMsg.textContent = `\${filename} を確認中...`;
        workflowStatusMsg.style.color = 'black';
        btnUploadWorkflow.classList.add('hidden');

        try {
            const url = `https://api.github.com/repos/\${user}/\${repoName}/contents/\${path}`;
            const response = await fetch(url, {
                headers: {
                    'Authorization': `token \${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (response.ok) {
                workflowStatusMsg.textContent = `✅ \${filename} は存在します。`;
                workflowStatusMsg.style.color = 'green';
            } else if (response.status === 404) {
                workflowStatusMsg.textContent = `⚠️ \${filename} が見つかりません。`;
                workflowStatusMsg.style.color = 'orange';
                btnUploadWorkflow.classList.remove('hidden');
                
                // Set up upload handler
                btnUploadWorkflow.onclick = () => uploadWorkflowFile(repoName, path);
            } else {
                throw new Error(`Status \${response.status}`);
            }
        } catch (err) {
            log(`ファイル確認エラー: \${err.message}`, 'error');
            workflowStatusMsg.textContent = `確認エラー: \${err.message}`;
        }
    }

    // Upload Workflow File
    async function uploadWorkflowFile(repoName, path) {
        const token = tokenInput.value;
        const user = userInput.value;
        const contentEncoded = btoa(DEFAULT_WORKFLOW_CONTENT); // Base64 encode

        if (!confirm(`\${repoName} に \${path} を作成しますか？`)) return;

        log(`\${path} をアップロード中...`);

        try {
            const url = `https://api.github.com/repos/\${user}/\${repoName}/contents/\${path}`;
            const response = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token \${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Add ${path} via Tauri Builder App`,
                    content: contentEncoded
                })
            });

            if (response.ok) {
                log(`成功！ \${path} を作成しました。`, 'success');
                workflowStatusMsg.textContent = `✅ \${path} を作成しました。`;
                workflowStatusMsg.style.color = 'green';
                btnUploadWorkflow.classList.add('hidden');
            } else {
                const errText = await response.text();
                throw new Error(`\${response.status} - \${errText}`);
            }
        } catch (err) {
            log(`アップロード失敗: \${err.message}`, 'error');
        }
    }

    // Repo Select Change Event
    repoSelect.addEventListener('change', () => {
        const repo = repoSelect.value;
        if (repo) {
            checkWorkflowExistence(repo);
        } else {
            workflowStatusArea.classList.add('hidden');
        }
    });

    // Workflow Filename Change Event
    workflowFileInput.addEventListener('change', () => {
        const repo = repoSelect.value;
        if (repo) {
            checkWorkflowExistence(repo);
        }
    });

    // Fetch Repositories
    document.getElementById('btn-fetch-repos').addEventListener('click', async () => {
        const token = tokenInput.value;
        const user = userInput.value;

        if (!token || !user) {
            log('TokenとUsernameを入力してください。', 'error');
            return;
        }

        log('リポジトリを取得中...');
        repoSelect.innerHTML = '<option value="">取得中...</option>';
        workflowStatusArea.classList.add('hidden');

        try {
            // Fetch all repos (pagination handled simply by asking for 100 per page)
            const response = await fetch(`https://api.github.com/users/\${user}/repos?per_page=100&sort=updated`, {
                headers: {
                    'Authorization': `token \${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });

            if (!response.ok) throw new Error(`API Error: \${response.status}`);
            
            const repos = await response.json();
            
            // Filter: has_pages === true
            const pageRepos = repos.filter(r => r.has_pages);

            repoSelect.innerHTML = '<option value="">リポジトリを選択してください...</option>';
            
            if (pageRepos.length === 0) {
                log('GitHub Pagesが有効なリポジトリが見つかりませんでした。', 'error');
                return;
            }

            pageRepos.forEach(repo => {
                const opt = document.createElement('option');
                opt.value = repo.name;
                opt.textContent = `\${repo.name} (Updated: \${new Date(repo.updated_at).toLocaleDateString()})`;
                repoSelect.appendChild(opt);
            });

            step2Card.classList.remove('opacity-50', 'pointer-events-none');
            log(`\${repos.length}件中、\${pageRepos.length}件のPages有効リポジトリを取得しました。`, 'success');

        } catch (err) {
            log(`エラー: \${err.message}`, 'error');
        }
    });

    // Trigger Build
    document.getElementById('btn-trigger-build').addEventListener('click', async () => {
        const token = tokenInput.value;
        const user = userInput.value;
        const repo = repoSelect.value;
        const workflowFile = document.getElementById('workflow-file').value;
        const branch = document.getElementById('target-branch').value;

        if (!repo) {
            log('リポジトリを選択してください。', 'error');
            return;
        }

        if (!confirm(`${repo} の ${branch} ブランチで ${workflowFile} を実行しますか？`)) return;

        log(`${workflowFile} の実行をリクエスト中...`);

        try {
            const url = `https://api.github.com/repos/${user}/${repo}/actions/workflows/${workflowFile}/dispatches`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    ref: branch
                })
            });

            if (response.ok) {
                log(`成功！ ${workflowFile} がトリガーされました。GitHub Actionsタブを確認してください。`, 'success');
                const actionsUrl = `https://github.com/${user}/${repo}/actions`;
                log(`<a href="${actionsUrl}" target="_blank" class="underline text-blue-400">ここをクリックしてActionsを開く</a>`);
            } else {
                const errText = await response.text();
                throw new Error(`${response.status} - ${errText}`);
            }

        } catch (err) {
            log(`ビルドトリガー失敗: ${err.message}`, 'error');
            if (err.message.includes('404')) {
                log('ヒント: Workflowファイル名が正しいか、Tokenに権限があるか確認してください。', 'info');
            }
        }
    });

</script>
</body>
</html>